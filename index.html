<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Jim Bungard Memorial Pony League — Standings & Results</title>
  <meta name="description" content="Official standings, weekly results, pairings, and league info for the Jim Bungard Memorial Pony League." />
  <meta name="theme-color" content="#0f3460" />
  <meta property="og:title" content="Pony League Standings — Jim Bungard Memorial" />
  <meta property="og:description" content="Live standings, weekly match results, pairings, key dates, and prize info for the Monday Night Winter Pony League." />
  <meta property="og:url" content="https://ponyleaguestandings.com/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Pony League Standings" />

  <style>
    /* ===== Base Theme (kept minimal to avoid conflicts) ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #fff;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: #fff; text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    header.page-header {
      text-align: center;
      margin: 16px 0 18px;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    h1 {
      font-size: 2.2em;
      margin-bottom: 8px;
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subhead { opacity: .85; }

    /* ===== Nav Tabs (your structure preserved) ===== */
    .nav-tabs {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 20px;
      margin: 0 auto 8px;
      border-bottom: 1px solid rgba(255,255,255,0.18);
    }
    .nav-tab {
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      padding: 8px 12px;
      border-radius: 999px;
      font: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: background .15s ease, border-color .15s ease;
    }
    .nav-tab:hover { background: rgba(255,255,255,0.14); }
    .nav-tab.active, .nav-tab[aria-selected="true"] {
      border-color: rgba(255,255,255,0.45);
      background: rgba(255,255,255,0.18);
    }

    /* ===== Panels ===== */
    .tab-content { display: block; }
    .tab-content[hidden] { display: none !important; }

    /* ===== Generic card/table (used by pairings too) ===== */
    .card {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 12px;
      overflow: hidden;
    }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      text-align: left;
    }
    .table thead th {
      background: rgba(255,255,255,0.08);
      font-weight: 700;
    }

    /* ===== Week Toggle (used by Pairings; mirrors your style) ===== */
    .week-toggle-wrap {
      margin: 12px 0 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .week-toggle {
      display: inline-flex;
      gap: 8px;
      padding-bottom: 4px;
      min-width: 100%;
    }
    .week-toggle .week-btn {
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      padding: 8px 12px;
      border-radius: 999px;
      font: inherit;
      cursor: pointer;
      white-space: nowrap;
    }
    .week-toggle .week-btn[aria-selected="true"] {
      border-color: rgba(255,255,255,0.45);
      background: rgba(255,255,255,0.18);
    }

    /* ===== Pairings scoped tweaks ===== */
    #pairings .pairings-week { margin-bottom: 22px; }
    #pairings .pairings-week[hidden] { display: none !important; }
    #pairings .pairings-table { width: 100%; border-collapse: collapse; }
    #pairings .pairing-vs { text-align: center; opacity: .75; width: 64px; }

    .alert {
      margin-top: 16px;
      padding: 12px 14px;
      border: 1px solid rgba(255,100,100,.35);
      background: rgba(255,100,100,.12);
      border-radius: 8px;
    }

    @media (max-width: 640px) {
      h1 { font-size: 1.8em; }
      .table th, .table td { padding: 9px 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Pony League Standings</h1>
      <p class="subhead">Jim Bungard Memorial — Monday Night Winter League</p>
    </header>
  </div>

  <!-- ===== NAV TABS (exactly as you provided) ===== -->
  <nav class="nav-tabs" role="tablist" aria-label="League sections"> 
    <button class="nav-tab active" role="tab" aria-selected="true" onclick="showTab('standings', this)">Standings</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('weekly-results', this)">Weekly Results</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('pairings', this)">Weekly Pairings</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('league-info', this)">League Info</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('prize-structure', this)">Prize Structure</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('side-pots', this)">Side Pots</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('hcp-brackets', this)">HCP Brackets</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('hcp-rev-brackets', this)">HCP Rev Brackets</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('scr-brackets', this)">SCR Brackets</button>
    <button class="nav-tab" role="tab" aria-selected="false" onclick="showTab('scr-rev-brackets', this)">SCR Rev Brackets</button>
  </nav>

  <!-- ===== PANELS ===== -->
  <main class="container">

    <!-- Standings -->
    <section id="standings" class="tab-content" role="tabpanel" aria-label="Standings">
      <div class="card" style="padding:16px;">
        <!-- Keep your existing Standings implementation here -->
        <p>Standings content goes here.</p>
      </div>
    </section>

    <!-- Weekly Results (placeholder so your existing script can populate) -->
    <section id="weekly-results" class="tab-content" role="tabpanel" aria-label="Weekly Results" hidden>
      <header style="margin: 10px 0 6px;">
        <h2 style="font-size:1.4rem;">Weekly Results</h2>
      </header>
      <div class="week-toggle-wrap">
        <div id="results-week-toggle" class="week-toggle"></div>
      </div>
      <div id="results-content"></div>
      <div id="results-error" class="alert" hidden></div>
    </section>

    <!-- Weekly Pairings (NEW) -->
    <section id="pairings" class="tab-content" role="tabpanel" aria-label="Weekly Pairings" hidden>
      <header style="margin: 10px 0 6px;">
        <h2 style="font-size:1.4rem;">Weekly Pairings</h2>
        <p class="subhead">Bowler vs. Bowler matchups by week</p>
      </header>

      <!-- Week Toggle -->
      <div class="week-toggle-wrap" role="tablist" aria-label="Pairings Week Selector">
        <div id="pairings-week-toggle" class="week-toggle"></div>
      </div>

      <!-- Content -->
      <div id="pairings-content"></div>

      <!-- Error -->
      <div id="pairings-error" class="alert" hidden></div>
    </section>

    <!-- League Info -->
    <section id="league-info" class="tab-content" role="tabpanel" aria-label="League Info" hidden>
      <div class="card" style="padding:16px;">
        <p>League information goes here.</p>
      </div>
    </section>

    <!-- Prize Structure -->
    <section id="prize-structure" class="tab-content" role="tabpanel" aria-label="Prize Structure" hidden>
      <div class="card" style="padding:16px;">
        <p>Prize structure content goes here.</p>
      </div>
    </section>

    <!-- Side Pots -->
    <section id="side-pots" class="tab-content" role="tabpanel" aria-label="Side Pots" hidden>
      <div class="card" style="padding:16px;">
        <p>Side pots content goes here.</p>
      </div>
    </section>

    <!-- HCP Brackets -->
    <section id="hcp-brackets" class="tab-content" role="tabpanel" aria-label="HCP Brackets" hidden>
      <div class="card" style="padding:16px;">
        <p>HCP Brackets content goes here.</p>
      </div>
    </section>

    <!-- HCP Rev Brackets -->
    <section id="hcp-rev-brackets" class="tab-content" role="tabpanel" aria-label="HCP Rev Brackets" hidden>
      <div class="card" style="padding:16px;">
        <p>HCP Rev Brackets content goes here.</p>
      </div>
    </section>

    <!-- SCR Brackets -->
    <section id="scr-brackets" class="tab-content" role="tabpanel" aria-label="SCR Brackets" hidden>
      <div class="card" style="padding:16px;">
        <p>SCR Brackets content goes here.</p>
      </div>
    </section>

    <!-- SCR Rev Brackets -->
    <section id="scr-rev-brackets" class="tab-content" role="tabpanel" aria-label="SCR Rev Brackets" hidden>
      <div class="card" style="padding:16px;">
        <p>SCR Rev Brackets content goes here.</p>
      </div>
    </section>

  </main>

  <!-- ===== SCRIPTS ===== -->
  <script>
    /* ---------------------------------
       Simple tab show/hide (kept light)
    ----------------------------------*/
    function showTab(id, btn) {
      document.querySelectorAll('.tab-content').forEach(el => el.hidden = true);
      const panel = document.getElementById(id);
      if (panel) panel.hidden = false;

      document.querySelectorAll('.nav-tab').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      if (btn) {
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
      }
    }

    /* ===========================================================
       WEEKLY PAIRINGS — Google Sheet CSV
       (Only touches #pairings; leaves rest of site alone)
    ============================================================ */
    const PAIRINGS_CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2B7Nwb1-bJ-hxu7Py10mcjPNURFulI2R-GDsMA4WnUOQmBxGLmtKBbUXpcw2njhS8flvRotMoPOUR/pub?gid=326412293&single=true&output=csv';

    const urlWeekParam = new URLSearchParams(location.search).get('week');

    // Quote-safe CSV parser
    function parseCSV(text) {
      const rows = []; let cur = '', row = [], inQ = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"' && !inQ) { inQ = true; continue; }
        if (c === '"' && inQ)  { if (n === '"') { cur += '"'; i++; } else { inQ = false; } continue; }
        if (c === ',' && !inQ) { row.push(cur.trim()); cur = ''; continue; }
        if ((c === '\n' || c === '\r') && !inQ) {
          if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }
          cur = ''; row = [];
          if (c === '\r' && n === '\n') i++;
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur.trim()); rows.push(row); }
      return rows;
    }

    async function initWeeklyPairings() {
      const toggleEl  = document.getElementById('pairings-week-toggle');
      const contentEl = document.getElementById('pairings-content');
      const errorEl   = document.getElementById('pairings-error');
      if (!toggleEl || !contentEl) return;

      try {
        const res = await fetch(PAIRINGS_CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Could not fetch Weekly Pairings CSV.');
        const csv = await res.text();
        const rows = parseCSV(csv);

        // Expect: Week, Bowler 1, Bowler 2
        const [header, ...data] = rows;
        if (!header || header.length < 3) throw new Error('CSV headers must be Week, Bowler 1, Bowler 2.');
        const h = header.map(x => (x||'').toLowerCase());
        const idxWeek = h.findIndex(x => x.includes('week'));
        const idxB1   = h.findIndex(x => x.includes('bowler') && x.includes('1'));
        const idxB2   = h.findIndex(x => x.includes('bowler') && x.includes('2'));
        if (idxWeek < 0 || idxB1 < 0 || idxB2 < 0) throw new Error('CSV headers must be Week, Bowler 1, Bowler 2.');

        // Group rows by week
        const groups = {};
        for (const r of data) {
          if (!r?.length) continue;
          const wRaw = (r[idxWeek] ?? '').trim();
          if (!wRaw) continue;
          const week = Number(String(wRaw).replace(/[^\d]/g,'')) || 0;
          const b1 = (r[idxB1] ?? '').trim();
          const b2 = (r[idxB2] ?? '').trim();
          (groups[week] ||= []).push({ b1, b2 });
        }

        const weeks = Object.keys(groups).map(Number).sort((a,b)=>a-b);
        if (!weeks.length) throw new Error('No pairings found.');

        // Current week = last with at least one non-TBD pairing
        const isFilled = m => {
          const bad = s => !s || s.toUpperCase() === 'TBD' || s === '-';
          return !bad(m.b1) && !bad(m.b2);
        };
        let currentWeek = weeks[0];
        for (const w of weeks) if (groups[w].some(isFilled)) currentWeek = w;
        if (urlWeekParam && weeks.includes(+urlWeekParam)) currentWeek = +urlWeekParam;

        // Build toggle buttons
        toggleEl.innerHTML = '';
        weeks.forEach(week => {
          const btn = document.createElement('button');
          btn.className = 'week-btn';
          btn.role = 'tab';
          btn.setAttribute('aria-selected', week === currentWeek ? 'true' : 'false');
          btn.setAttribute('aria-controls', `pairings-week-${week}`);
          btn.textContent = `Week ${week}`;
          btn.addEventListener('click', () => showPairingsWeek(week));
          toggleEl.appendChild(btn);
        });

        // Build per-week tables (bowler vs bowler only)
        contentEl.innerHTML = '';
        weeks.forEach(week => {
          const sec = document.createElement('section');
          sec.id = `pairings-week-${week}`;
          sec.className = 'pairings-week';
          sec.hidden = week !== currentWeek;

          const table = document.createElement('table');
          table.className = 'pairings-table table';

          table.innerHTML = `
            <thead>
              <tr>
                <th>Bowler</th>
                <th class="pairing-vs">vs</th>
                <th>Bowler</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;

          const tbody = table.querySelector('tbody');
          groups[week].forEach(({b1,b2}) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${b1 || 'TBD'}</td>
              <td class="pairing-vs">—</td>
              <td>${b2 || 'TBD'}</td>
            `;
            tbody.appendChild(tr);
          });

          sec.appendChild(table);
          contentEl.appendChild(sec);
        });

        // Hide future weeks by default
        weeks.forEach(w => {
          if (w > currentWeek) {
            const sec = document.getElementById(`pairings-week-${w}`);
            if (sec) sec.hidden = true;
          }
        });

        // Local controller
        function showPairingsWeek(week) {
          toggleEl.querySelectorAll('.week-btn').forEach(btn => {
            btn.setAttribute('aria-selected', btn.textContent.endsWith(String(week)) ? 'true' : 'false');
          });
          weeks.forEach(w => {
            const sec = document.getElementById(`pairings-week-${w}`);
            if (sec) sec.hidden = (w !== week);
          });
          const usp = new URLSearchParams(location.search);
          usp.set('week', String(week));
          history.replaceState(null, '', `${location.pathname}?${usp.toString()}#pairings`);
        }

        // Deep link support
        if (location.hash.includes('pairings') && urlWeekParam) {
          showPairingsWeek(Number(urlWeekParam));
        }

      } catch (e) {
        console.error(e);
        if (errorEl) {
          errorEl.textContent = e.message || 'Failed to load Weekly Pairings.';
          errorEl.hidden = false;
        }
      }
    }

    // Lazy-init ONLY when the Pairings tab is shown (respects your showTab)
    document.addEventListener('DOMContentLoaded', () => {
      const target = document.getElementById('pairings');
      if (!target) return;
      let initialized = false;
      const initIfNeeded = () => {
        if (!initialized && !target.hasAttribute('hidden')) {
          initialized = true;
          initWeeklyPairings();
        }
      };
      if (!target.hasAttribute('hidden')) { initialized = true; initWeeklyPairings(); }
      else { new MutationObserver(initIfNeeded).observe(target, { attributes: true, attributeFilter: ['hidden'] }); }
    });
  </script>
</body>
</html>
